\documentclass[]{report}
\usepackage {graphicx}
\usepackage{amsmath} 
\usepackage{abstract}
\usepackage{caption}
\usepackage{float} 
\usepackage{subcaption}
     
\begin {document}

\begin {titlepage}

	\centering\
	\textsc{\huge University of Dublin} \\ [1.5cm]

\includegraphics [scale=0.6]{../../trinityCollege.jpg} \\[1.5cm]
	\textsc{\huge Trinity College}\\ [0.5cm]
	\textsc{\large Raspberry Spi}\\ [0.5cm]

Ellen Marie Burke  \\ B.A. (Mod.) Computer Science \\ Final Year Project April 2014 \\ Supervisor: Fergal Shevlin \\[2.0cm]

	\textsc{\large School of Computer Science and Statistics} \\ 
	\textsc{\large O'Reilly Institute, Trinity College, Dublin 2, Ireland} \\ 
\end {titlepage}



\renewcommand{\abstractname}{}    % Remove the word abstract
\renewcommand{\absnamepos}{empty}
\begin {abstract}
	\textsc{\huge Declaration} \\[1.5cm]
I hereby declare that this project is entirely my own work and that it has not been submitted as an exercise for a degree at this or any other university \\ [2.0cm]
	\textbf{Ellen Marie Burke 23rd April 2014}
\end {abstract}

\begin {abstract}
	\textsc{\huge Acknowledgements} \\[2.0cm]
  Thank you to everyone who helped me throughout this project 
\end {abstract}

\begin {abstract}
	\textsc{\huge Abstract}  \\[1.0cm]
	Security systems set up in homes can be expensive and complex to set up. The cameras used can be bulky in size and therefore difficult to successfully hide. This project is to create a home security system using a Raspberry Pi and the Raspberry Pi camera module.   
\end {abstract}


\tableofcontents
\chapter {Introduction}
\label {ch:intro} 

Home security systems have been available for a few years now. Most are quite expensive and are very obvious to spot. The camera used in them may not be able to supply 1080p video.

\section {Motivation/Problem}
\label {sec:motprob}
% Aim & What is Raspberry Spi?
The aim of this project is to create a home security system in a different way. It will be affordable and easy to use for all kinds of end users.\\

The Raspberry Spi will allow users to set up a system and have complete control over it. It will allow for additional features to be used and has endless possibilities of features that can be implemented as extras or change current features. 
% How is it different from other security systems?
Raspberry Spi differs from other security systems with regards to size and cost. The Raspberry Spi approximately costs 30 Euro and the camera module is approximately 20 Euro. The dimensions of the Pi are 85.60mm x 56mm x 21mm. The camera module is even smaller in size.
% 
\section {Background Research}
\label {sec:research}
Objective of the research is to \ldots

\subsection {Android}
\label {subsec:Android}
The original idea was to create an Android app for the Raspberry Spi. From this the end user would control the Raspberry Spi. On the app the images would be viewed, motion would be started \& stopped and the live stream would be viewed.\\

If an Android app had of been used this would mean that this project would only be useful to users who had access to an Android phone. This project would be unavailable to iPhone users, Windows users and users who would access it through a computer browser.

\section {Technical Approach/Methodology}
\label {sec:tech}
Technical approach is \ldots
% 
\chapter {Design}
\label {ch:design}
% Hardware required
	One of the main aims of this project is to make it easy for others to set up. With this in mind there are not a lot of hardware components required for the Raspberry Spi. Additional hardware items such as a keyboard and mouse would only be needed for initial set up. But can be used if needed. \\
	
\section {Hardware}	
\label {sec:hardware}

The following is a list of hardware components:\\
\begin {itemize}
  \item Raspberry Pi Model B\\
  \item Raspberry Pi Model B Case\\
  \item Raspberry Pi Camera Module\\
  \item USB Hub powered externally\\
  \item Wifi Adapter\\
  \item SD card\\
\end {itemize} 

\noindent\\
{\bf Raspberry Pi Model B:} \\
\break
The Raspberry Pi is described as a credit card sized computer. There are two available models but for this project Model B is used. The features on a Raspberry Pi are:
\begin {itemize}
  \item ARM Processor capable of 700 MHz\\
  \item 512 MB (Shared with the GPU)\\
  \item HDMI\\
  \item Composite RCA connector\\
  \item CSI connector for the Raspberry Pi Camera\\
  \item 2 USB ports\\
  \item 3.5mm Audio Jack\\
\end {itemize}
  
% Reference Image: http://readwrite.com/2014/01/20/raspberry-pi-everything-you-need-to-know#awesm=~oBwfeWDLWC0rMX

\begin {figure}[ht!]
	\centering	
	\includegraphics [scale=0.23]{../../Pictures/modelb.jpg}\\
	\caption{Raspberry Pi Model B board layout}
\end {figure}

\noindent
{\bf Raspberry Pi Case:} \\ 
\break
Most Raspberry Pi's may not be sold with an external case. The case is essential because otherwise the Raspberry will have no protection and can get damaged very easily. A model B case is needed so there is space for the camera module to connect to the CSI connector on the Raspberry board. Model A did not have a space for the camera to connect so they have a different style case.\\
\clearpage
\noindent
{\bf Raspberry Pi Camera Module:} \\
\break
The camera module is a camera that has been designed specifically for the Raspberry Pi. It connects directly into the pi to the CSI connector rather than USB. The CSI connector exclusively carries pixel data and because of this it is capable of extremely high data rates.\\

The camera itself is not expensive yet it can output images and video of very high quality. For images the max resolution capable is 2592 x 1944. Video is capable of being captured in 1080p quality.\\

There is an infared filter on the camera and therefore it cannot detect IR. There is another camera module called the Pi Noir which is available.\\ 


% Reference Image: board + cam http://www.adafruit.com/products/1367
%
% cam http://embeddedcomputer.nl/media/catalog/product/cache/1/image/650x650/9df78eab33525d08d6e5fb8d27136e95/r/a/raspberry_pi_camera_board.jpg

\begin {figure}[H]
	\centering	
	\includegraphics [scale=0.5]{../../Pictures/raspberry_pi_camera_board.jpg} 
	\caption{Raspberry Pi Camera Module\\}	
\end {figure}
\begin {figure}[H]
	\centering
\includegraphics [scale=1.0]{../../Pictures/camattachedraspberry.jpg} 
	\caption{Camera Module attached to the Raspberry board with no casing}
\end {figure}
%{\vspace{5mm}}
\noindent
{\bf USB Hub powered externally:}\\
\break
A USB Hub is required to attach any USB components. If any component is connected by USB directly to the Pi, the Pi will power it. This will cause the Pi to heat up. If the Raspberry is left on for several hours, as this project aims to be, it could cause damage to the Pi. An externally powered USB hub will allow for the Pi to avoid heating up and create more USB slots available without affecting the Pi.\\ 

No particular external USB hub is needed any USB hub can be used.\\

\noindent
{\bf Wifi Adapter:}\\
\break
When connecting to the internet a Wifi Adapter will be more useful then an Ethernet cable. By using an adapter it will avoid having to hide another cable and overall make the Pi neater to set up.\\

Using a Wifi Adapter is not a requirement of this project but is more of a recommendation. This is a decision the end user will make.\\

\noindent
{\bf SD card:}\\
\break
An SD card will act as storage for the Pi. Most Raspberry Pi's do not come with an SD card and must be bought separately. The Raspberry Pi has no on board memory. An operating system will be loaded onto it and it will also store all images taken.\\

External hard drives can also be used to store the images but that will be another decision left to the end user. The storage device chosen depends on how frequent the Raspberry Spi will be used.\\


\section {Software}	
\label {sec:software}	
% Software required
The following is a list of all the software that will need to be installed:
\begin {itemize}
  \item Operating System Raspian \\
  \item UV4L (Universal Video 4 Linux)\\  
  \item OpenCV\\
  \item Apache\\
  \item Motion\\
\end {itemize}

\noindent
{\bf Operating System Raspian:}\\
\break
With the Raspberry Pi there are several operating systems to choose from. This project uses Raspian because it is the most popular OS for the Pi. Being the most popular it is easy to debug problems and solve issues that arise when searching online.\\ 

\noindent
{\bf UV4L (Universal Video 4 Linux):}\\
\break
The camera modules default driver is called RaspiCam. RaspiCam does not work properly with OpenCV. When OpenCV tries to locate a camera it looks for a device ID. The camera module does have a device ID but it's not an integer value. It's the value 'pi' because of this OpenCV cannot use the Camera Module with it's default drivers. To get around this driver problem UV4L (Universal Video 4 Linux) is used instead. UV4L allows OpenCV to locate and use the Camera.

When using this driver the UV4L initializing script must be run. It can be added to the Raspberry's start up script or can be called after each boot. The parameters passed in can be interchangeable.\\

\noindent
{\bf OpenCV:}\\
\break
For all video and image processing the computer vision library OpenCV is used.\\

OpenCV will be responsible for taking a real time photo and motion detection.\\

\noindent
{\bf Apache:}\\
\break
Apache web hosting will be used to host the Raspberry Spi website. Apache will continue running as a background process. While the Pi is handling motion detection, taking photos the website will be able to be accessed and process requests received.\\ 

\noindent
{\bf Motion:}\\
\break
Motion is a program that will handle the video live streaming. Motion can be configured in many ways. From which port the video will stream, how many FPS (frames per second) are displayed to whether the live stream should be saved.\\

\section {Additional Requirements}	
\label {sec:additional}
Aside from the mentioned hardware and software mentioned in the previous section there are other requirements and additional features that an end user can user.\\

\noindent
{\bf Port Forwarding:}\\
\break
With the Raspberry Spi being set up on a home network port forwarding needs to be enabled. This project will not be able to work at all unless port forwarding is set up.\\

Port forwarding will different for each end users router. For this reason no explanation will be given and the end user will need to consult their router manual or search for the answer online. \\

A list of all ports that need to be open will be provided. \\

The following ports that will be used are:

\begin {center}
    \begin {tabular}{ | l | p{7cm} |}
    \hline
    {\bf Port} & {\bf Port used for} \\ \hline
   80 & HTTP Requests \\ \hline 
   8000/9000 or 8080 & Video Live Streaming but can be changed\\ \hline
	22 & SSH into the Raspberry (Optional) \\ \hline
    \end {tabular}
    \\[0.5cm]
\end {center} 

Port 80 is necessary and until this port is open the Raspberry Spi website will not be accessible. With port 80 open when the router receives a HTTP request it will know which device on the network to send the request to.\\

Port 22 is optional and will depend on how the end user will interact and make changes on the Raspberry Pi itself. If port 22 is open this will allow a user to SSH directly into it. SSHing into the Pi will let the user make changes from another computer instead of using the Raspberry and having to attach a keyboard and mouse.\\

Port 8000/9000 or 8080 is going to be used for live streaming. This port can be changed but will default to one of these ports. Changing the port that will be used for live streaming can be done in the Motion configuration file.\\

\noindent
{\bf A browser with JavaScript enabled:}\\
\break
This project has a JavaScript function. Due to using JavaScript a browser that has JavaScript needs to be used when viewing the website.\\

If viewing the website on the Raspberry Pi itself the only browser currently that has JavaScript enabled is Chromium.\\
%
%
\chapter {Implementation}
\label {ch:implem}
% Website
\section {Web Application}
\label {sec:webapp}
% Help page
How the site is made.\\
Once port forwarding has been set up the Raspberry Spi web application will be available on the external IP of the home network.

{\bf List of options available from the homepage:}
\begin {itemize}
  \item View Photos Currently stored on the Pi\\
  \item Take a real time photo\\
  \item Start \& Stop Motion Detection\\
  \item Video Live Streaming\\
  \item Help Page\\
\end {itemize}

\begin {figure}[H]
	\centering	
	\includegraphics [scale=0.7]{../../Pictures/HomePage.jpg} 
	\caption{Home page with list of options\\}	
\end {figure}

\subsection {Accessing the Web Application}
\label {subsec:accesswebpage}

Accessing the website will require a username and password to view any pages. The access is controlled by a .htaccess file. This file is an Apache configuration file. In this file it will store what will be displayed when asking for the password. Currently the only information that will displayed to the user before they enter a user name or password is the words Raspberry Spi to let the user know what they are logging in to.\\

Passwords are not kept in the same file or directory as the web pages. This is so they cannot be accessed on accident or viewed. The passwords and associated user names are stored in a .htpasswd. The passwords are encrypted and cannot be read. If a user would like to add a user or password it will need to be added from the actual Pi not the web application. The web application will provide no hints to password or user name or any way to change either. This is done to avoid malicious attempts to access the Raspberry.\\

\section {Help Page}
\label {sec:help}

A help page will be available on each page. It is there to answer problems that occurred most frequently when implementing and testing this project.\\

The questions are also available in a .txt file in case the web page is not accessible.\\

{The questions are:\\}

\begin {itemize}
  \item The camera doesn't open?
  \item How does the motion detection work? 
  \item The webpage is unavailable?
  \item When taking a live frame the webpage displays "Frame not read correctly"?
  \item How to SSH into the Raspberry Spi?
  \item Only a partial image was taken while using motion detection?
  \item where are the web pages stored on the pi?
  \item Source code for the Raspberry Spi?
  \item Question not here?
\end {itemize}



\begin {figure}[H]
	\centering	
	\includegraphics [scale=0.7]{../../Pictures/HelpPage.jpg} 
	\caption{Help Page\\}	
\end {figure}


\section {Real Time Photo}
\label {sec:photo}

Explain opencv works. Why CGI and how that works. <Example image output>
Taking a real time photo is an option that allows the user to take a photo with the click of a button and then view it. This photo is taken by using a Common Gateway Interface CGI script.\\

CGI scripting is a way for a web user to click an option on a web page, the web server will then send the request server side where the application is then carried out. For this project the CGI application is done using C++.\\

{\bf The CGI opens the camera and will return one of these three options.}


\begin{enumerate}
  \item The camera did not open successfully
  \item The frame taken is empty
  \item The frame has been read correctly\\
\end{enumerate}  

Only if the frame is successful will a proper web page load. If the camera doesn't open or the frame is empty is will display the error to the user.\\

\begin {figure}[H]
	\centering	
	\includegraphics [scale=0.7]{../../Pictures/TakeLivePhoto.jpg} 
	\caption{After taking a live frame\\}	
\end {figure}



\section {Motion Detection}
\label {sec:motion}
% LiveStreaming
\subsection {How Motion Detection Works}
\label {subsec:motionworks}
Motion detection is done by using the OpenCV library. The method chosen for motion detection is Absolute Difference. This method will detect changes happening after new frames are read in. This method was chosen because it is effective at detecting motion while not killing the pi.\\

OpenCV has an inbuilt function called {\it absdiff()}. This method takes in two RGB frames. The two frames are then subtracted from one another producing a new RGB image that contains the differences if any. RGB images are not useful when looking for changes so the difference image is converted to grayscale. This means that the image will only contain black and white pixels making it easier to see if there are any changes from one frame to the next. If there are no changes the image will only contain black pixels. When there are changes white pixels will appear. The white pixels are counted and if there are more pixels then a certain count then motion has been detected.\\


	{\it absdif(prevFrame - nextFrame = difference)\\}

	{\it  grayscale(difference)\\}

	{\it  checkWhiteCount (difference)	\\}
	
	{\it  if WhiteCount is above threshold save images	\\}


If motion does get detected the RGB frames that were originally read in are saved. Since the difference image will not mean anything it does not get saved.\\

If motion gets detected then the images are not saved and new images are read in.\\ 


\subsection {Motion Detection Web Page}
\label {subsec:motionwebpage}

On the motion detection web page there are two options. Start motion and stop motion. If motion is currently running it will be displayed to the user. There will be text displaying if the motion is on or off and a small icon will appear as well.\\



\begin{figure}[htbp]
  \begin{minipage}[b]{0.62\linewidth}
    \centering
    \includegraphics[width=\linewidth]{../../Pictures/raspberrySPYstart.png} 
    \caption{Motion Detection Start icon}
    \label{fig:start}
  \end{minipage}
  \hspace{0.5cm}
  \begin{minipage}[b]{0.62\linewidth}
    \centering
    \includegraphics[width=\linewidth]{../../Pictures/raspberrySPYstop.png} 
    \caption{Motion Detection Stop icon}
    \label{fig:stop}
  \end{minipage}
\end{figure}






{\bf Screenshots from the motion detection area on the web application\\}

\begin {figure}[H]
	\centering	
	\includegraphics [scale=0.7]{../../Pictures/MotionDetectionStart.jpg} 
	\caption{Motion Detection page\\}	
\end {figure}

\begin {figure}[H]
	\centering	
	\includegraphics [scale=0.7]{../../Pictures/MotionStarted.jpg} 
	\caption{Motion Detection after being started\\}	
\end {figure}

\begin {figure}[H]
	\centering	
\includegraphics [scale=0.7]{../../Pictures/MotionStopped.jpg}
	\caption{Motion Detection after being stopped\\}	
\end {figure}



\section {Video Live Streaming}
\label {sec:video}
% Future Possibilites
Motion. How motion(live streaming) works.
Motion is a program that is available to download. It sets up a video stream and will display images from the camera attached to the Pi to a given web page. It can also offer to do motion detection but since is been implemented using OpenCV this aspect of Motion is not in use.\\

Before Motion is used it is configured from how many frames it will display per second to the port the video is displayed on. Motion will take frames that are

This feature currently does not work properly or efficiently.\\

The video live streaming option on the home page of the web application does not start or stop streaming. It will display a blank page as to avoid effecting other features from working and effecting the pi connecting to the internet. Having this feature working properly would be an area of this project that could be expanded upon or changed in the future\\


\chapter {Testing}
\label {ch:test}
%
%
%
%
%
\chapter {Conclusion}
\label {ch:concl}
%
%
% 42
%
%
The aim of this project was to built a different kind of security system that is affordable and easy to use but also effective. Raspberry Spi has achieved this. It is an affordable set up that is easy to control. Users are able to view photos previously taken or captured from motion detection, live stream video or start and stop motion detection.\\

Various changes can be made to match each user depending on their preference. It can have multiple real life uses for varying end users. Being set up on a home network allows for having full control over the system from who can access the Raspberry to the resolution of images being used.\\

All of the Raspberry Spi code is available to download from github which allows for endless possibilities of additional extras.\\

\noindent
{\bf Raspberry Spi Code is available here:}\\
{\\http://www.github.com/Smellen/RaspberrySpi}


\subsection {Future Work}
\label {subsec:future}

The video streaming does not work well or efficiently. To continue working on this project this area would involve either a completely new approach or continue using the program Motion but try to implement it working better alongside Apache.\\

Adding to this project even more would be adding in more Raspberry Pis. One Pi per room or as many as preferred. One Pi controlling the web page and the rest  only taking photos, motion detection and live streaming.\\ 

%RaspberrySpi Logo
\newpage
\begin {figure}[H]
	\centering	
\includegraphics [scale=0.5]{../../Pictures/raspberrySPY.png} 
\end {figure}



\begin {thebibliography}{9}
  %Example reference for later
   \bibitem{notes} John W. Dower {\em Readings compiled for History
  21.479.}  1991.

\end {thebibliography}	

\end {document} 